<!DOCTYPE html>
<html>
<head>
    <title>Rate Limiting Visual Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .request {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .pending { background: #f0f0f0; }
        .running { background: #fff3cd; }
        .success { background: #d4edda; }
        .failed { background: #f8d7da; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
        }
        #stats {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
        }
        .log {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <h1>Finale API Rate Limiting Test</h1>
    <p>This page tests the rate limiting implementation by making multiple API requests.</p>
    
    <div>
        <button onclick="testRateLimiting()">Test Rate Limiting (10 requests)</button>
        <button onclick="testBurst()">Test Burst (20 requests)</button>
        <button onclick="clearResults()">Clear</button>
    </div>
    
    <div id="stats">
        <strong>Statistics:</strong>
        <div>Total Time: <span id="totalTime">0</span>ms</div>
        <div>Requests/Second: <span id="requestRate">0</span></div>
        <div>Average Delay: <span id="avgDelay">0</span>ms</div>
    </div>
    
    <h3>Requests:</h3>
    <div id="requests"></div>
    
    <h3>Console Log:</h3>
    <div id="console" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;"></div>

    <script>
        const API_URL = 'http://localhost:3000/api/test-finale-simple';
        let requestId = 0;
        
        function log(message) {
            const consoleDiv = document.getElementById('console');
            const logEntry = document.createElement('div');
            logEntry.className = 'log';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleDiv.appendChild(logEntry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        async function makeRequest(id) {
            const requestDiv = document.createElement('div');
            requestDiv.id = `request-${id}`;
            requestDiv.className = 'request pending';
            requestDiv.innerHTML = `Request #${id}: <span class="status">Pending...</span>`;
            document.getElementById('requests').appendChild(requestDiv);
            
            const startTime = Date.now();
            requestDiv.className = 'request running';
            requestDiv.querySelector('.status').textContent = 'Running...';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const duration = Date.now() - startTime;
                const data = await response.json();
                
                requestDiv.className = 'request success';
                requestDiv.querySelector('.status').textContent = `✓ Completed in ${duration}ms`;
                log(`Request #${id} completed in ${duration}ms`);
                
                return { success: true, duration, startTime };
            } catch (error) {
                const duration = Date.now() - startTime;
                requestDiv.className = 'request failed';
                requestDiv.querySelector('.status').textContent = `✗ Failed: ${error.message}`;
                log(`Request #${id} failed: ${error.message}`);
                
                return { success: false, duration, startTime };
            }
        }
        
        async function testRateLimiting() {
            clearResults();
            log('Starting rate limiting test with 10 requests...');
            
            const startTime = Date.now();
            const promises = [];
            
            // Launch 10 requests simultaneously
            for (let i = 1; i <= 10; i++) {
                promises.push(makeRequest(i));
            }
            
            const results = await Promise.all(promises);
            const totalTime = Date.now() - startTime;
            
            // Calculate statistics
            const successCount = results.filter(r => r.success).length;
            const requestRate = (successCount / (totalTime / 1000)).toFixed(2);
            
            // Calculate average delay between requests
            const sortedResults = results.sort((a, b) => a.startTime - b.startTime);
            let totalDelay = 0;
            for (let i = 1; i < sortedResults.length; i++) {
                totalDelay += sortedResults[i].startTime - sortedResults[i-1].startTime;
            }
            const avgDelay = Math.round(totalDelay / (sortedResults.length - 1));
            
            // Update stats
            document.getElementById('totalTime').textContent = totalTime;
            document.getElementById('requestRate').textContent = requestRate;
            document.getElementById('avgDelay').textContent = avgDelay;
            
            log(`Test completed: ${successCount}/10 successful in ${totalTime}ms (${requestRate} req/s)`);
            
            // Check if rate limiting is working
            if (requestRate <= 2.5 && requestRate >= 1.5) {
                log('✓ Rate limiting is working correctly (≈2 requests/second)');
            } else if (requestRate > 5) {
                log('✗ Rate limiting may not be working (too fast)');
            } else {
                log('⚠ Rate limiting active but slower than expected');
            }
        }
        
        async function testBurst() {
            clearResults();
            log('Starting burst test with 20 requests...');
            
            const startTime = Date.now();
            const promises = [];
            
            // Launch 20 requests simultaneously
            for (let i = 1; i <= 20; i++) {
                promises.push(makeRequest(i));
            }
            
            const results = await Promise.all(promises);
            const totalTime = Date.now() - startTime;
            
            const successCount = results.filter(r => r.success).length;
            const requestRate = (successCount / (totalTime / 1000)).toFixed(2);
            
            document.getElementById('totalTime').textContent = totalTime;
            document.getElementById('requestRate').textContent = requestRate;
            
            log(`Burst test completed: ${successCount}/20 successful in ${totalTime}ms`);
            log(`Expected time for 20 requests at 2/sec: ~10 seconds`);
            log(`Actual time: ${(totalTime / 1000).toFixed(1)} seconds`);
        }
        
        function clearResults() {
            document.getElementById('requests').innerHTML = '';
            document.getElementById('console').innerHTML = '';
            requestId = 0;
            log('Cleared results');
        }
        
        // Initial message
        log('Rate limiting test ready. Click a button to start.');
        log('Expected behavior: ~2 requests per second with queuing');
    </script>
</body>
</html>